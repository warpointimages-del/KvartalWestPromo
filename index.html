<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>РОЗЫГРЫШ ПРИЗОВ | WARPOINT</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="scroll-animate">
        <div class="header-logos">
            <img src="pics/kvartal.webp" alt="KVARTAL WEST" class="logo-kvartal">
            <img src="pics/logo.svg" alt="WARPOINT" class="logo-warpoint">
        </div>
        <div class="header-text">
            <h1>РОЗЫГРЫШ <span class="highlight">ПРИЗОВ</span></h1>
            <p class="subtitle">Участвуй и выиграй крутые призы!</p>
        </div>

        <div class="prizes-grid">
            <div class="prize-card">
                <img src="pics/ps5.webp" alt="PlayStation 5" class="prize-image">
                <h3 class="prize-place" style="color: #ffd700;">1 МЕСТО</h3>
                <p class="prize-name">PlayStation 5</p>
            </div>
            <div class="prize-card">
                <img src="pics/vr.webp" alt="VR шлем" class="prize-image">
                <h3 class="prize-place" style="color: #c0c0c0;">2 МЕСТО</h3>
                <p class="prize-name">Oculus Quest 3S</p>
            </div>
            <div class="prize-card">
                <img src="pics/speaker.webp" alt="Колонка" class="prize-image">
                <h3 class="prize-place" style="color: #cd7f32;">3 МЕСТО</h3>
                <p class="prize-name">Яндекс Станция Миди</p>
            </div>
        </div>
    </header>

    <section class="registration scroll-animate">
        <h2>ЗАПИСЬ НА <span class="highlight">УЧАСТИЕ</span></h2>
        
        <!-- Кастомная стилизованная форма -->
        <div class="custom-form-container">
            <form id="warpointForm" class="warpoint-form">
                <div class="form-field">
                    <label for="fullName" class="field-label">ФИО</label>
                    <input type="text" id="fullName" required class="warpoint-input" placeholder="Фамилия Имя Отчество">
                </div>

                <div class="form-field">
                    <label for="birthDate" class="field-label">Дата рождения</label>
                    <input type="date" id="birthDate" required class="warpoint-input">
                </div>

                <div class="form-field">
                    <label for="phone" class="field-label">Телефон</label>
                    <input type="tel" id="phone" required class="warpoint-input" placeholder="+7 (999) 999-99-99">
                </div>

                <!-- Блок с соцсетями -->
                <div class="social-requirements">
                    <p class="social-title">ПОДПИШИСЬ НА НАШИ СОЦСЕТИ ДЛЯ УЧАСТИЯ</p>
                    <div class="social-buttons">
                        <a href="https://t.me/kvartal_west" target="_blank" class="social-btn" data-social="kvartal">
                            <img src="https://img.icons8.com/?size=100&id=lUktdBVdL4Kb&format=png&color=000000" alt="Telegram" class="social-icon">
                            <span>KVARTAL WEST</span>
                        </a>
                        <a href="https://t.me/warpoint_moscow" target="_blank" class="social-btn" data-social="moscow">
                            <img src="https://img.icons8.com/?size=100&id=lUktdBVdL4Kb&format=png&color=000000" alt="Telegram" class="social-icon">
                            <span>WARPOINT MOSCOW</span>
                        </a>
                        <a href="https://t.me/warpointarena" target="_blank" class="social-btn" data-social="arena">
                            <img src="https://img.icons8.com/?size=100&id=lUktdBVdL4Kb&format=png&color=000000" alt="Telegram" class="social-icon">
                            <span>WARPOINT ARENA</span>
                        </a>
                        <a href="https://vk.com/warpoint_msk" target="_blank" class="social-btn" data-social="vk">
                            <img src="https://img.icons8.com/?size=100&id=Mgea1VSzCVcS&format=png&color=000000" alt="VK" class="social-icon">
                            <span>VK WARPOINT</span>
                        </a>
                    </div>
                </div>

                <button type="submit" class="warpoint-submit-btn" id="submitBtn" disabled>
                    <span class="btn-text">УЧАСТВОВАТЬ В РОЗЫГРЫШЕ</span>
                </button>
            </form>
            
            <div id="message" class="message"></div>
        </div>
    </section>

    <footer class="scroll-animate">
        <img src="pics/logo.svg" alt="WARPOINT" class="logo-small">
        <p class="secondary">© 2025 Все права защищены</p>
    </footer>

    <script>
        // Анимация при скролле
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.scroll-animate').forEach(el => {
            observer.observe(el);
        });

        // URL вашего Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwEznqQZH39IO13Nlv8gtvlLnSyNiMa41qc-tTt62PmSXDYqXnkhWcfXEX_6bII9HM4/exec';

        class WarpointForm {
            constructor() {
                this.form = document.getElementById('warpointForm');
                this.messageDiv = document.getElementById('message');
                this.submitBtn = document.getElementById('submitBtn');
                this.socialButtons = document.querySelectorAll('.social-btn');
                
                this.subscribedSocials = this.loadProgress();
                this.init();
            }
            
            init() {
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                
                // Маска для телефона
                const phoneInput = document.getElementById('phone');
                phoneInput.addEventListener('input', (e) => this.formatPhone(e.target));
                
                // Обработчики для соцсетей
                this.socialButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleSocialClick(e));
                });
                
                // Проверяем прогресс при загрузке
                this.checkSubmitAvailability();
            }
            
            loadProgress() {
                // Загружаем прогресс из localStorage
                const saved = localStorage.getItem('warpointSocialProgress');
                return saved ? JSON.parse(saved) : {
                    kvartal: false,
                    moscow: false,
                    arena: false,
                    vk: false
                };
            }
            
            saveProgress() {
                // Сохраняем прогресс в localStorage
                localStorage.setItem('warpointSocialProgress', JSON.stringify(this.subscribedSocials));
            }
            
            handleSocialClick(e) {
                e.preventDefault();
                const social = e.currentTarget.getAttribute('data-social');
                const url = e.currentTarget.getAttribute('href');
                
                // Отмечаем соцсеть как посещенную
                this.subscribedSocials[social] = true;
                this.saveProgress();
                
                // Обновляем внешний вид кнопки
                this.updateSocialButton(e.currentTarget);
                
                // Проверяем доступность отправки
                this.checkSubmitAvailability();
                
                // Открываем ссылку в новой вкладке
                window.open(url, '_blank');
            }
            
            updateSocialButton(button) {
                const social = button.getAttribute('data-social');
                if (this.subscribedSocials[social]) {
                    button.classList.add('subscribed');
                }
            }
            
            checkSubmitAvailability() {
                const allSubscribed = Object.values(this.subscribedSocials).every(val => val === true);
                this.submitBtn.disabled = !allSubscribed;
                
                // Обновляем все кнопки
                this.socialButtons.forEach(btn => {
                    this.updateSocialButton(btn);
                });
            }
            
            formatPhone(input) {
                let numbers = input.value.replace(/\D/g, '');
                
                if (numbers.startsWith('7') || numbers.startsWith('8')) {
                    numbers = '7' + numbers.substring(1);
                } else if (numbers.startsWith('9')) {
                    numbers = '7' + numbers;
                }
                
                if (numbers.length > 0) {
                    let formatted = '+7 ';
                    if (numbers.length > 1) {
                        formatted += '(' + numbers.substring(1, 4);
                    }
                    if (numbers.length >= 4) {
                        formatted += ') ' + numbers.substring(4, 7);
                    }
                    if (numbers.length >= 7) {
                        formatted += '-' + numbers.substring(7, 9);
                    }
                    if (numbers.length >= 9) {
                        formatted += '-' + numbers.substring(9, 11);
                    }
                    input.value = formatted;
                }
            }
            
            async handleSubmit(e) {
                e.preventDefault();
                
                const formData = {
                    fullName: document.getElementById('fullName').value.trim(),
                    birthDate: document.getElementById('birthDate').value,
                    phone: document.getElementById('phone').value.replace(/\D/g, '')
                };
                
                if (!this.validateData(formData)) {
                    return;
                }
                
                this.setLoading(true);
                
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    if (response.ok || response.status === 0 || response.type === 'opaque') {
                        this.showMessage('ВЫ УСПЕШНО ЗАРЕГИСТРИРОВАНЫ', 'success');
                        this.form.reset();
                        // Сбрасываем прогресс после успешной отправки
                        this.resetProgress();
                    } else {
                        this.showMessage('ОШИБКА ПРИ ОТПРАВКЕ', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.showMessage('ВЫ УСПЕШНО ЗАРЕГИСТРИРОВАНЫ', 'success');
                    this.form.reset();
                    this.resetProgress();
                } finally {
                    this.setLoading(false);
                }
            }
            
            resetProgress() {
                // Сбрасываем прогресс после успешной отправки
                this.subscribedSocials = {
                    kvartal: false,
                    moscow: false,
                    arena: false,
                    vk: false
                };
                this.saveProgress();
                this.checkSubmitAvailability();
            }
            
            validateData(data) {
                if (data.fullName.length < 2) {
                    this.showMessage('ВВЕДИТЕ КОРРЕКТНОЕ ФИО', 'error');
                    return false;
                }
                
                if (!data.birthDate) {
                    this.showMessage('ВВЕДИТЕ ДАТУ РОЖДЕНИЯ', 'error');
                    return false;
                }
                
                const birthDate = new Date(data.birthDate);
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                if (age < 13) {
                    this.showMessage('ДЛЯ УЧАСТИЯ НЕОБХОДИМО БЫТЬ СТАРШЕ 13 ЛЕТ', 'error');
                    return false;
                }
                
                if (data.phone.length !== 11) {
                    this.showMessage('ВВЕДИТЕ КОРРЕКТНЫЙ НОМЕР ТЕЛЕФОНА', 'error');
                    return false;
                }
                
                return true;
            }
            
            setLoading(loading) {
                this.submitBtn.disabled = loading || !this.checkSubmitAvailability();
                const btnText = this.submitBtn.querySelector('.btn-text');
                btnText.textContent = loading ? 'ОТПРАВКА...' : 'УЧАСТВОВАТЬ В РОЗЫГРЫШЕ';
            }
            
            showMessage(text, type) {
                this.messageDiv.innerHTML = `<span class="highlight">${text}</span>`;
                this.messageDiv.className = `message ${type}`;
                
                setTimeout(() => {
                    this.messageDiv.innerHTML = '';
                    this.messageDiv.className = 'message';
                }, 5000);
            }
        }

        // Инициализация формы
        document.addEventListener('DOMContentLoaded', function() {
            new WarpointForm();
        });
    </script>
</body>
</html>
